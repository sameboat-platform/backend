#!/usr/bin/env bash
# Pre-commit hook
# Enable shared hooks: git config --local core.hooksPath .githooks
# Ensure executable: chmod +x .githooks/pre-commit scripts/check-migration-immutability.sh

set -euo pipefail

# --- 1) Warn loudly if CI override env var is set ------------------------------
if [[ "${ALLOW_CI_EDIT:-}" == "1" ]]; then
  echo "⚠️  WARNING: ALLOW_CI_EDIT is set!"
  echo "   This will allow changes to .github/workflows/backend-ci.yml."
  echo "   Make sure this is intentional."
fi

# --- 2) Protect critical CI workflow (backend-ci.yml) ------------------------
# Block committing changes to backend-ci.yml unless override env is set
if git diff --cached --name-only | grep -q '^\.github/workflows/backend-ci\.yml$'; then
  if [[ "${ALLOW_CI_EDIT:-}" != "1" ]]; then
    echo "❌ backend-ci.yml is protected."
    echo "   If this change is intentional, set ALLOW_CI_EDIT=1 and retry the commit."
    echo "   Examples by shell:"
    echo "     • Git Bash:      ALLOW_CI_EDIT=1 git commit -m \"ci: intentional backend-ci change\""
    echo "     • PowerShell:    $env:ALLOW_CI_EDIT='1'; git commit -m \"ci: intentional backend-ci change\"; Remove-Item Env:ALLOW_CI_EDIT"
    echo "     • cmd.exe:       set ALLOW_CI_EDIT=1 && git commit -m \"ci: intentional backend-ci change\" && set ALLOW_CI_EDIT="
    exit 1
  fi
fi

# --- 3) Migration immutability enforcement -----------------------------------
# Your existing check (must exit non-zero on violation)
if [[ -x scripts/check-migration-immutability.sh ]]; then
  scripts/check-migration-immutability.sh
else
  echo "⚠️  Warning: scripts/check-migration-immutability.sh not found or not executable; skipping."
fi

# If you reach here, the commit can proceed
exit 0
